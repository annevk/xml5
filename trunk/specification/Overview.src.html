<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
 <head>
  <title>XML5</title>
  <style type="text/css">
   pre.idl { border:solid thin; background:#eee; color:#000; padding:0.5em }
   pre.idl :link, pre.idl :visited { color:inherit; background:transparent }
   pre code { color:inherit; background:transparent }
   div.example { margin-left:1em; padding-left:1em; border-left:double; color:#222; background:#fcfcfc }
   .note { margin-left:2em; font-weight:bold; font-style:italic; color:#008000 }
   p.note::before { content:"Note: " }
   .issue { padding:.5em; border:solid #f00 }
   p.issue::before { content:"Issue: " }
   em.ct { text-transform:lowercase; font-variant:small-caps; font-style:normal }
   dfn { font-weight:bold; font-style:normal }
   code { color:orangered }
   code :link, code :visited { color:inherit }
   dl.switch { padding-left: 2em; }
   dl.switch dt { text-indent: -1.5em; }
   dl.switch dt:before { content: '\21AA'; padding: 0 0.5em 0 0; display: inline-block; width: 1em; text-align: right; line-height: 0.5em; }
  </style>
  <link rel="stylesheet" href="http://www.w3.org/StyleSheets/TR/base">
 </head>
 <body>
  <h1>XML5</h1>
  
  <p class="issue">...</p>
  
  <h2>Writing XML documents</h2>
  
  <p class="issue">...</p>
  
  <h2>Parsing XML documents</h2>
  
  <p><em>This section only applies to user agents, data mining tools, and
  conformance checkers.</em></p>
  
  <p>The rules in this section define the <dfn>XML parser</dfn>.

  <p>This specification defines the parsing rules for XML documents, whether
  they are syntactically valid or not. Certain points in the parsing algorithm
  are said to be <dfn title="parse error">parse errors</dfn>. The error handling
  for parse errors is well-defined: user agents <em class="ct">must</em> either
  act as described below when encountering such problems, or
  <em class="ct">must</em> abort processing at the first error that they
  encounter for which they do not wish to apply the rules described below.</p>
  <!-- XXX -->
  
  <h3>Overview of the parsing model</h3>
  
  <p>The input to the XML parsing process consists of a stream of Unicode
  characters, which is passed through a <span>tokenization</span> stage (lexical
  analysis) followed by a <span>tree construction</span> stage (semantic
  analysis). The output is a <code>Document</code> object.</p>
  
  <h3>The input stream stage</h3>
  
  <p>The stream of Unicode characters that consists the input to the
  tokenization stage will be initially seen by the user agent as a stream of
  bytes (typically coming over the network or from the local file system). The
  bytes encode the actual characters according to a particular <em>character
  encoding</em>, which the user agent must use to decode the bytes into
  characters.</p>
  
  <p class="issue">Define how to find the character encoding...</p>
  
  <h3>The tokenization stage</h3>
  
  <p class="issue">...</p>
  

  <dl>
   <dt><dfn>Data state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0026 (<code>&amp;</code>)
     
     <dd class="issue">...</dd>

     <dt>U+003C (<code>&lt;</code>)</dt>
     <dd>Switch to the <span>tag state</span>.</dd>

     <dt>EOF</dt>
     
     <dd>Emit an end-of-file token.</dd>

     <dt>Anything else</dt>
     
     <dd>Emit the input character as character token. Stay in this state.</dd>
    </dl>
   </dd>

   <dt><dfn>Tag state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+002F (<code>/</code>)</dt>
     
     <dd>Switch to the <span>end tag state</span>.</dd>

     <dt>U+003F (<code>?</code>)</dt>
     
     <dd>Switch to the <span>pi state</span>.</dd>

     <dt>U+0021 (<code>!</code>)</dt>
     <dd>Switch to the <span>markup declaration state</span>.</dd>
     
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>

     <dt>U+003C (<code>&lt;</code>)</dt>
     <dt>U+003E (<code>></code>)</dt>
     <dt>EOF</dt>
     
     <dd><span>Parse error</span>. Reprocess the character in the <span>bogus
     comment state</span>.</dd>
     
     <dt>Anything else</dt>
     
     <dd>Create a new tag token and set its name to the input character, then
     switch to the <span>tag name state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>End tag state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     
     <dd>Emit a short end tag token and then switch to the <span>data
     state</span>.</dd>

     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>

     <dt>U+003C (<code>&lt;</code>)</dt>
     <dt>EOF</dt>
     
     <dd>Unconsume the last two characters and then switch to the <span>bogus
     comment state</span>.</dd>

     <dt>Anything else</dt>
     
     <dd>Create an end tag token and set its name to the input character, then
     switch to the <span>end tag name state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>End tag name state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>

     <dd>Switch to the <span>end tag name after state</span>.</dd>

     <dt>EOF</dt>
     
     <dd><span>Parse error</span>. Emit the current token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>U+003E (<code>></code>)</dt>
     <dd>Emit the current token and then switch to the <span>data
     state</span>.</dd>
     
     <dt>Anything else</dt>
     
     <dd>Append  the current input character to the tag name and stay in the
     current state.</dd>
    </dl>
   </dd>

   <dt><dfn>End tag name after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd>Emit the current token and then switch to the <span>data state</span>.</dd>
     
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token and then reprocess the
     current input character in the <span>data state</span>.</dd>
     
     <dt>Anything else</dt>
     <dd><span>Parse error</span>. Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>Pi state</dfn></dt>
   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>bogus comment state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Create a new processing instruction token. Set target to the current
     input character and data to the empty string. Then switch to the <span>pi
     target state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>Pi target state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>pi target after state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>U+003F (<code>?</code>)</dt>
     <dd>Switch to the <span>pi after state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the tag name and stay in the
     current state.</dd>
    </dl>
   </dd>

   <dt><dfn>Pi target after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>Anything else</dt>
     <dd>Reprocess the current input character in the <span>pi data
     state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>Pi data state</dfn></dt>
   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003F (<code>?</code>)</dt>
     <dd>Switch to the <span>pi after state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the pi's data and stay in the
     current state.</dd>
    </dl>
   </dd>

   <dt><dfn>Pi after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd>Emit the current token and then switch to the <span>data state</span>.</dd>

     <dt>U+003F (<code>?</code>)</dt>
     <dd>Append the current input character to the pi's data and stay in the
     current state.</dd>

     <dt>Anything else</dt>
     <dd>Reprocess the current input character in the <span>pi data
     state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>Markup declaration state</dfn></dt>
   <dd>
    <p>If the next two characters are both U+002D (<code>-</code>)
    characters, consume those two characters, create a comment token whose data
    is the empty string and then switch to the <span>comment state</span>.</p>
    
    <p>Otherwise, if the next seven characters are a case-sensitive match for
    "[CDATA[", then consume those characters and switch to the <span>CDATA
    state</span>.</p>
    
    <p>Otherwise, if the next seven characters are a case-sensitive match for
    "DOCTYPE", then this is a <span>parse error</span>. Consume those characters
    and switch to the <span>DOCTYPE state</span>.</p>
    <!-- or should we make them legal? -->

    <p>Otherwise, this is a <span>parse error</span>. Switch to the <span>bogus
    comment state</span>.</p>
   </dd>

   <dt><dfn>Comment state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+002D (<code>-</code>)</dt>
     <dd>Switch to the <span>comment dash state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the comment token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current character to the comment data.</dd>
    </dl>
   </dd>

   <dt><dfn>Comment dash state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+002D (<code>-</code>)</dt>
     <dd>Switch to the <span>comment end state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the comment token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append a U+002D (<code>-</code>) and the current input character to the
     comment token's data. Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>Comment end state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd>Emit the comment token. Switch to the <span>data state</span>.</dd>

     <dt>U+002D (<code>-</code>)</dt>
     <dd>Append the current input character to the comment token's data. Stay in
     the current state.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the comment token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append two U+002D (<code>-</code>) characters and the current input
     character to the comment token's data. Switch to the <span>comment
     state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>CDATA state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+005D (<code>]</code>)</dt>
     <dd>Switch to the <span>CDATA bracket state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Emit the current input character as character token. Stay in the
     current state.</dd>
    </dl>
   </dd>

   <dt><dfn>CDATA bracket state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+005D (<code>]</code>)</dt>
     <dd>Switch to the <span>CDATA end state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Emit a U+005D (<code>]</code>) character as character token and also
     emit the current input character as character token. Stay in the current
     state.</dd>
    </dl>
   </dd>

   <dt><dfn>CDATA end state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>U+005D (<code>]</code>)</dt>
     <dd>Emit the current input character as character token. Stay in the
     current state.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reconsume the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Emit two U+005D (<code>]</code>) characters as character tokens and
     also emit the current input character as character token. Switch to the
     <span>CDATA state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE root name before state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>
     
     <dt>Anything else</dt>
     <dd>Reprocess the current input character in the <span>bogus comment
     state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE root name before state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>U+003E (<code>></code>)</dt>
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>.
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Switch to the <span>DOCTYPE root name state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE root name state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE root name after state</span>.</dd>

     <dt>U+003E (<code>></code>)</dt>
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>U+005B (<code>[</code>)</dt>
     <dd>Switch to the <span>DOCTYPE internal subset state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>
     
     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE root name after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>DOCTYPE identifier double quoted state</span>.</dd>

     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>DOCTYPE identifier single quoted state</span>.</dd>

     <dt>U+005B (<code>[</code>)</dt>
     <dd>Switch to the <span>DOCTYPE internal subset state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE identifier double quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>DOCTYPE root name after state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE identifier single quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>DOCTYPE root name after state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE internal subset state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003C (<code>&lt;</code>)</dt>
     <dd>Switch to the <span>DOCTYPE tag state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>U+0025 (<code>%</code>)</dt>
     <dd class="issue"> consume parameter entity </dd>

     <dt>U+005D (<code>]</code>)</dt>
     <dd>Switch to the <span>DOCTYPE internal subset after state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE internal subset after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE tag state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0021 (<code>!</code>)</dt>
     <dd>Switch to the <span>DOCTYPE markup declaration state</span>.</dd>

     <dt>U+003F (<code>?</code>)</dt>
     <dd>Switch to the <span>DOCTYPE pi state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Switch to the <span>DOCTYPE bogus comment state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE markup declaration state</dfn></dt>
   <dd>
    <p>If the next two characters are both U+002D (<code>-</code>) characters,
    then consume those characters and switch to the <span>DOCTYPE comment
    state</span>.</p>

    <p>Otherwise, if the next six characters are a case-sensitive match for
    "ENTITY", then consume those characters and switch to the
    <span>DOCTYPE ENTITY state</span>.</p>
    
    <p>Otherwise, if the next seven characters are a case-sensitive match for
    "ATTLIST", then consume those characters and switch to the <span>DOCTYPE
    ATTLIST state</span>.</p>
    
    <p>Otherwise, if the next eight characters are a case-sensitive match for
    "NOTATION", then consume those characters and switch to the <span>DOCTYPE
    NOTATION state</span>.</p>
    
    <p>Otherwise, switch to the <span>DOCTYPE bogus comment state</span>.</p>
    <!-- xxx parse error somewhere here? -->
   </dd>

   <dt><dfn>DOCTYPE comment state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+002D (<code>-</code>)</dt>
     <dd>Switch to the <span>DOCTYPE comment dash state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE comment dash state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+002D (<code>-</code>)</dt>
     <dd>Switch to the <span>DOCTYPE comment end state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>

     <dd>Switch to the <span>DOCTYPE comment state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE comment end state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd>Switch to the <span>DOCTYPE internal subset state</span>.</dd>

     <dt>U+002D (<code>-</code>)</dt>
     <dd>Switch to the <span>DOCTYPE comment dash state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>

     <dd>Switch to the <span>DOCTYPE comment state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY type before state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Switch to the <span>DOCTYPE bogus comment state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY type before state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>U+0025 (<code>%</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY parameter before state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd class="issue"> ... </dd>
     <!--
            self.currentToken = {"type":"entity", "name":data, "value":""}
     <dd>Switch to the <span>DOCTYPE ENTITY name state</span>.</dd>
     -->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY parameter before state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY parameter state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Switch to the <span>DOCTYPE bogus comment state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY parameter state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd class="issue"> ... </dd>
     <!--
            self.currentToken = {"type":"parameterEntity", "name":data,
              "value":""}
     <dd>Switch to the <span>DOCTYPE ENTITY name state</span>.</dd>
     -->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY name state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY name after state</span>.</dd>

     <dt>EOF</dt>
<!--xxx            # XXX parse error
            self.currentToken = None -->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd class="issue"> ... </dd>
     <!--
     <dd>Append the current input character to the tag name and stay in the current state.</dd>
     -->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY name after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY value double quoted state</span>.</dd>

     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY value single quoted state</span>.</dd>

     <dt>EOF</dt>
<!--xxx            # XXX parse error
            self.currentToken == None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>

     <dd>Switch to the <span>DOCTYPE ENTITY identifier state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY value double quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <!-- XXX "%" -->

    <dl class="switch">
     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY value after state</span>.</dd>

     <dt>U+0026 (<code>&amp;</code>):
     <dd class="issue">... normalize numeric entities only</dd>

     <dt>EOF</dt><!--xxx
            # XXX parse error
            self.currentToken == None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current entity token's
     value.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY value single quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <!-- "%" -->

    <dl class="switch">
     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY value after state</span>.</dd>

     <dt>U+0026 (<code>&amp;</code>):
     <dd class="issue">... normalize numeric entities only</dd>

     <dt>EOF</dt><!--xxx
            # XXX parse error
            self.currentToken == None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current entity token's
     value.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY value after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>U+003E (<code>></code>)</dt>
     <dd class="issue">do something with the entity token</dd>

     <dt>EOF</dt><!-- xxx
            # XXX parse error
            self.currentToken == None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY identifier state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd class="issue"> append entity ... </dd>

     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY identifier double quoted state</span>.</dd>

     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY identifier single quoted state</span>.</dd>

     <dt>EOF</dt><!-- xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY identifier double quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY identifier state</span>.</dd>

     <dt>EOF</dt><!--xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ENTITY identifier single quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ENTITY identifier state</span>.</dd>

     <dt>EOF</dt><!--xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST name before state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Switch to the <span>DOCTYPE bogus comment state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST name before state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd class="issue">...</dd>
<!--xxx
            self.currentToken = {"name":data, "attrs":[]}
     <dd>Switch to the <span>DOCTYPE ATTLIST name state</span>.</dd>-->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST name state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST name after state</span>.</dd>

     <dt>EOF</dt>
     <!-- xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd class="issue">...</dd>
     <!--<dd>Append  the current input character to the tag name and stay in the current state.</dd>-->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST name after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>U+003E (<code>></code>)</dt><!-- xxx
            self.currentToken = None-->
     <dd>Switch to the <span>DOCTYPE internal subset state</span>.</dd>

     <dt>EOF</dt><!-- xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd class="issue">...</dd>
        <!--    self.currentToken["attrs state</span>.</dd>.append({"name":data, "type":"",
              "dv":""})
     <dd>Switch to the <span>DOCTYPE ATTLIST attribute name state</span>.</dd>-->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST attribute name state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST attribute name after state</span>.</dd>

     <dt>EOF</dt><!-- xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd class="issue">...</dd>
<!--            self.currentToken["attrs state</span>.</dd>[-1]["name state</span>.</dd> += data-->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST attribute name after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>EOF</dt><!-- xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd class="issue">...</dd><!--
            self.currentToken["attrs state</span>.</dd>[-1]["type state</span>.</dd> += data
     <dd>Switch to the <span>DOCTYPE ATTLIST attribute type state</span>.</dd>-->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST attribute type state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST attribute type after state</span>.</dd>

     <dt>EOF</dt><!-- xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd class="issue">...</dd>
<!--            self.currentToken["attrs state</span>.</dd>[-1]["type state</span>.</dd> += data-->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST attribute type after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>U+0023 (<code>#</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST attribute declaration before state</span>.</dd>

     <dt>EOF</dt><!--
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Switch to the <span>DOCTYPE bogus comment state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST attribute declaration before state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE bogus comment state</span>.</dd>

     <dt>EOF</dt><!--xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST attribute declaration
     state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST attribute declaration state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST attribute declaration after state</span>.</dd>

     <dt>EOF</dt><!--xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST attribute declaration after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>U+003E (<code>></code>)</dt>
     <dd>Switch to the <span>DOCTYPE internal subset state</span>.</dd>

     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST attribute value double quoted state</span>.</dd>

     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST attribute value single quoted state</span>.</dd>

     <dt>EOF</dt><!--xxx
            # XXX parse error
            self.currentToken = None-->
     <dd>Switch to the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd class="issue"> ... </dd>
<!--            self.currentToken["attrs state</span>.</dd>.append({"name":data, "type":"",
              "dv":""})
     <dd>Switch to the <span>DOCTYPE ATTLIST attribute name state</span>.</dd>-->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST attribute value double quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST name after state</span>.</dd>
<!--
     <dt>U+0025 (<code>%</code>)</dt>
            raise NotSupportedError
-->
     <dt>U+0026 (<code>&amp;</code>):
     <dd class="issue">...</dd>

     <dt>Anything else</dt>
     <dd class="issue="> ... </dd>
     <!-- self.currentToken["attrs state</span>.</dd>[-1]["dv state</span>.</dd> += data-->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE ATTLIST attribute value single quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>DOCTYPE ATTLIST name after state</span>.</dd>
<!--
     <dt>U+0025 (<code>%</code>)</dt>
            raise NotSupportedError
-->
     <dt>U+0026 (<code>&amp;</code>):
     <dd class="issue">...</dd>

     <dt>Anything else</dt>
     <dd class="issue"> ... </dd>
     <!--       self.currentToken["attrs state</span>.</dd>[-1]["dv state</span>.</dd> += data-->
    </dl>
   </dd>

   <dt><dfn>DOCTYPE NOTATION state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>DOCTYPE NOTATION identifier state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Switch to the <span>DOCTYPE bogus comment state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE NOTATION identifier state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd>Switch to the <span>DOCTYPE internal subset state</span>.</dd>

     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>DOCTYPE NOTATION identifier double quoted state</span>.</dd>

     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>DOCTYPE NOTATION identifier single quoted state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE NOTATION identifier double quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>DOCTYPE NOTATION identifier state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE NOTATION identifier single quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>DOCTYPE NOTATION identifier state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>

     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE pi state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003F (<code>?</code>)</dt>
     <dd>Switch to the <span>DOCTYPE pi after state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE pi after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd>Switch to the <span>DOCTYPE internal subset state</span>.</dd>

     <dt>U+003F (<code>?</code>)</dt>
     <dd>Stay in the current state.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Switch to the <span>DOCTYPE pi state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>DOCTYPE bogus comment state</dfn></dt>
   <dd><p>Consume every character up to the first U+003E (<code>></code>) or
   EOF, whichever comes first. Emit a comment token whose data is the
   concatenation of all those consumed characters. Then consume the next input
   character and switch to the <span>DOCTYPE internal subset state</span>
   reprocessing the EOF character if that was the character consumed.</p></dd>

   <dt><dfn>Tag name state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>tag attribute name before state</span>.</dd>

     <dt>U+003E (<code>></code>)</dt>
     <dd>Emit the current token and then switch to the <span>data state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>U+002F (<code>/</code>)</dt>
     <dd>Switch to the <span>empty tag state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append  the current input character to the tag name and stay in the
     current state.</dd>
    </dl>
   </dd>

   <dt><dfn>Empty tag state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+003E (<code>></code>)</dt>
     <dd>Emit the current tag token as empty tag token and then switch to the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd><span>Parse error</span>. Reprocess the current input character in the
     <span>tag attribute name before state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>Tag attribute name before state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>

     <dd>Stay in the current state.</dd>

     <dt>uU+003E (<code>></code>)</dt>
     <dd>Emit the current token and then switch to the <span>data state</span>.</dd>

     <dt>U+002F (<code>/</code>)</dt>
     <dd>Switch to the <span>Empty tag state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Start a new attribute in the current tag token. Set that attribute's
     name to the current input character and its value to the empty string and
     then switch to the <span>tag attribute name state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>Tag attribute name state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+003D (<code>=</code>)</dt>
     <dd>Switch to the <span>tag attribute value before state</span>.</dd>

     <dt>U+003E (<code>></code>)</dt>
     <dd>Emit the current token as start tag token. Switch to the <span>data
     state</span>.</dd>
     
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>tag attribute name after state</span>.</dd>

     <dt>U+002F (<code>/</code>)</dt>
     <dd>Switch to the <span>Empty tag state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token as start tag token and
     then reprocess the current input character in the <span>data
     state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current attribute's name.
     Stay in the current state.</dd>
    </dl>

    <p>When the user agent leaves this state (and before emitting the tag token,
    if appropriate), the complete attribute's name <em class="ct">must</em> be
    compared to the other attributes on the same token; if there is already an
    attribute on the token with the exact same name, then this is a parse error
    and the new attribute <em class="ct">must</em> be dropped, along with the
    value that gets associated with it (if any).</p>
   </dd>

   <dt><dfn>Tag attribute name after state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>U+003D (<code>=</code>)</dt>
     <dd>Switch to the <span>tag attribute value before state</span>.</dd>

     <dt>U+003E (<code>></code>)</dt>
     <dd>Emit the current token and then switch to the <span>data state</span>.</dd>

     <dt>U+002F (<code>/</code>)</dt>
     <dd>Switch to the <span>empty tag state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Start a new attribute in the current tag token. Set that attribute's
     name to the current input character and its value to the empty string and
     then switch to the <span>tag attribute name state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>Tag attribute value before state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Stay in the current state.</dd>

     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>tag attribute value double quoted state</span>.</dd>

     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>tag attribute value single quoted state</span>.</dd>

     <dt>U+0026 (<code>&amp;</code>):
     <dd>Reprocess the input character in the <span>tag attribute value unquoted
     state</span>.</dd>

     <dt>U+003E (<code>></code>)</dt>
     <dd>Emit the current token and then switch to the <span>data state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current attribute's value and
     then switch to the <span>tag attribute value unquoted state</span>.</dd>
    </dl>
   </dd>

   <dt><dfn>Tag attribute value double quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0022 (<code>"</code>)</dt>
     <dd>Switch to the <span>tag attribute name before state</span>.</dd>

     <dt>U+0026 (<code>&amp;</code>)</dt>
     <dd class="issue">...</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the input character to the current attribute's value. Stay in
     the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>Tag attribute value single quoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">
     <dt>U+0027 (<code>'</code>)</dt>
     <dd>Switch to the <span>beforeattribute name state</span>.</dd>

     <dt>U+0026 (<code>&amp;</code>)</dt>
     <dd class="issue">...</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token and then reprocess the
     current input character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the input character to the current attribute's value. Stay in
     the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>Tag attribute value unquoted state</dfn></dt>

   <dd>
    <p>Consume the <span>next input character</span>:</p>
    <dl class="switch">
     <dt>U+0009</dt>
     <dt>U+000A</dt>
     <dt>U+0020</dt>
     <dd>Switch to the <span>tag attribute name before state</span>.</dd>

     <dt>U+0026 (<code>&amp;</code>):
     <dd class="issue">...</dd>

     <dt>U+003E (<code>></code>)</dt>
     <dd>Emit the current token as start tag token and then switch to the
     <span>data state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current token as start tag token and
     then reprocess the current input character in the
     <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the input character to the current attribute's value. Stay in
     the current state.</dd>
    </dl>
   </dd>

   <dt><dfn>Bogus comment state</dfn></dt>
   
   <dd><p>Consume every character up to the first U+003E (<code>></code>) or
   EOF, whichever comes first. Emit a comment token whose data is the
   concatenation of all those consumed characters. Then consume the next input
   character and switch to the <span>data state</span> reprocessing the EOF
   character if that was the character consumed.</p></dd>
  </dl>

  <h3>The tree construction stage</h3>
  
  <p>The input to the tree construction stage is a sequence of tokens from the
  <span>tokenization</span> stage. The output of this stage is a tree model
  represented by a <code>Document</code> object.</p>
  
  <p>The tree construction stage passes through several phases. The initial
  phase is <span>the start phase</span>.</p>
  
  <p>The <dfn>stack of open elements</dfn> contains all elements of which the
  closing tag has not yet been encountered. Once the first start tag token in
  <span>the start phase</span> is encountered it will contain one open element.
  The rest of the elements are added during <span>the main phase</span>.</p>
  
  <p>The <dfn>current element</dfn> is the bottommost node in this stack.</p>
  
  <p>The <span>stack of open elements</span> is said to <dfn>have an element in
  scope</dfn> if the target element is in the stack of open elements.</p>

  <p>When the steps below require the user agent to <dfn>append a
  character</dfn> to a node, the user agent <em class="ct">must</em> collect it
  and all subsequent consecutive characters that would be appended to that node
  and insert one <code>Text</code> node whose data is the concatenation of all
  those characters.</p>
  
  <p class="issue">Need to define <dfn>create an element for the
  token</dfn>...</p>
  <!-- namespaces and such -->

  <p>When the steps below require the user agent to <dfn>insert an element</dfn>
  for a token the user agent <em class="ct">must</em> <span>create an element
  for the token</span> and then append it to the <span>current element</span>
  and push it into the <span>stack of open elements</span> so
  that it becomes the new <span>current element</span>.</p>

  <h4>The start phase</h4>

  <p>Each token emitted from the tokenization stage <em class="ct">must</em> be
  processed as follows until the algorithm below switches to a different
  phase:</p>

  <dl class="switch">
   <dt>A start tag token</dt>

   <dd><p><span>Create an element for the token</span> and then append it to the
   <code>Document</code> node and push it into the <span>stack of open
   elements</span>. This element is the root element and the first <span>current
   element</span>. Then switch to <span>the main phase</span>.</p></dd>

   <dt>An empty tag token</dt>
   
   <dd><p><span>Create an element for the token</span> and append it to the
   <code>Document</code> node. Then switch to <span>the end
   phase</span>.</p></dd>

   <dt>A comment token</dt>

   <dd><p>Append a <code>Comment</code> node to the <code>Document</code> node
   with the <code>data</code> attribute set to the data given in the
   token.</p></dd>

   <dt>A processing instruction token</dt>

   <dd><p>Append a <code>ProcessingInstruction</code> node to the
   <code>Document</code> node with the <code>target</code> and <code>data</code>
   atributes set to the target and data given in the token.</p></dd>

   <dt>An end-of-file token</dt>

   <dd><p><span>Parse error</span>. Reprocess the token in <span>the end
   phase</span>.</p></dd>

   <dt>Anything else</dt>
   
   <dd><p><span>Parse error</span>. Ignore the token.</p></dd>
  </dl>
   
  <h4>The main phase</h4>
  
  <p>Once a start tag token has been encountered (as detailed in the previous
  phase) each token <em class="ct">must</em> be process using the following
  steps until further notice:</p>
  
  <dl class="switch">
   <dt>A character token</dt>
   
   <dd><p><span>Append a character</span> to the <span>current
   element</span>.</p></dd>

   <dt>A start tag token</dt>

   <dd><p><span>Insert an element</span> for the token.</p></dd>

   <dt>An empty tag token</dt>
   
   <dd><p><span>Create an element for the token</span> and append it to the
   <span>current element</span>.</p></dd>

   <dt>An end tag token</dt>

   <dd>
    <p>If the tag name of the <span>current node</span> does not match the tag
    name of the end tag token this is a <span>parse error</span>.</p>

    <p>If there is an <span>element in scope</span> with the same tag name as
    that of the token pop nodes from the <span>stack of open elements</span>
    until the first such element has been popped from the stack.</p>
    
    <p>If there are no more elements on the stack of open elements at this point
    switch to <span>the end phase</span>.</p>
   </dd>

   <dt>A short end tag token</dt>

   <dd><p>Pop an element from the <span>stack of open elements</span>. If there
   are no more elements on the stack of open elements switch to <span>the end
   phase</span>.</p></dd>

   <dt>A comment token</dt>
   
   <dd><p>Append a <code>Comment</code> node to the <span>current element</span>
   with the <code>data</code> attribute set to the data given in the
   token.</p></dd>
   
   <dt>A processing instruction token</dt>
   
   <dd><p>Append a <code>ProcessingInstruction</code> node to the <span>current
   element</span> with the <code>target</code> and <code>data</code> atributes
   set to the target and data given in the token.</p></dd>
   
   <dt>An end-of-file token</dt>

   <dd><p><span>Parse error</span>. Reprocess the token in <span>the end
   phase</span>.</p></dd>
  </dl>
  
  <h4>The end phase</h4>

  <p>Tokens in the end phase <em class="ct">must</em> be handled as follows:</p>

  <dl class="switch">
   <dt>A comment token</dt>

   <dd><p>Append a <code>Comment</code> node to the <code>Document</code> node
   with the <code>data</code> attribute set to the data given in the
   token.</p></dd>

   <dt>A processing instruction token</dt>

   <dd><p>Append a <code>ProcessingInstruction</code> node to the
   <code>Document</code> node with the <code>target</code> and <code>data</code>
   atributes set to the target and data given in the token.</p></dd>

   <dt>An end-of-file token</dt>

   <dd><p><span>Stop parsing</span>.</p></dd>

   <dt>Anything else</dt>

   <dd><p><span>Parse error</span>. Ignore the token.</p></dd>
  </dl>

  <p>Once the user agent <dfn title="stop parsing">stops parsing</dfn> the
  document, it <em class="ct">must</em> follow these steps:</p>

  <ol class="issue">
   <li>...</li>
  </ol>
 </body>
</html>
